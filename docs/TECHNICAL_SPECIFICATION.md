# Техническое задание: AI Chat Bot для Telegram

## 1. Общее описание проекта

### 1.1 Назначение системы
AI Chat Bot для Telegram - это интеллектуальный бот, предоставляющий пользователям доступ к различным AI моделям через OpenRouter API. Система обеспечивает персонализированное общение с AI, обработку файлов и изображений, а также административное управление пользователями.

### 1.2 Цели проекта
- Предоставить удобный интерфейс для взаимодействия с AI моделями
- Обеспечить контролируемый доступ через систему ключей
- Реализовать масштабируемую архитектуру для развертывания на VPS
- Создать систему мониторинга и аналитики использования

### 1.3 Область применения
- Персональные помощники на базе AI
- Корпоративные чат-боты для внутреннего использования
- Образовательные платформы с AI поддержкой
- Исследовательские проекты в области NLP

## 2. Функциональные требования

### 2.1 Основные функции

#### 2.1.1 Пользовательские функции
- **Аутентификация по ключам доступа**
  - Ввод уникального ключа доступа при первом запуске
  - Автоматическое сохранение сессии пользователя
  - Проверка активности ключа доступа

- **Текстовое общение с AI**
  - Отправка текстовых сообщений к AI моделям
  - Получение ответов с форматированием Telegram
  - Сохранение контекста диалога (до 20 сообщений)
  - Поддержка различных AI моделей (GPT-4, Claude, Gemini и др.)

- **Обработка файлов**
  - Загрузка и анализ текстовых документов (TXT, PDF, DOCX)
  - Анализ изображений (JPG, JPEG, PNG, GIF, WEBP)
  - Ограничение размера файлов (до 20MB)
  - Автоматическое извлечение текста из документов

- **Управление диалогом**
  - Очистка контекста чата командой `/clear`
  - Просмотр статуса пользователя командой `/status`
  - Получение справки командой `/help`

#### 2.1.2 Административные функции
- **Управление ключами доступа**
  - Генерация новых ключей доступа
  - Просмотр списка всех ключей
  - Деактивация ключей доступа
  - Отслеживание использования ключей

- **Управление пользователями**
  - Просмотр списка всех пользователей
  - Получение статистики по пользователю
  - Блокировка/разблокировка пользователей
  - Назначение административных прав

- **Аналитика и мониторинг**
  - Общая статистика использования
  - Мониторинг баланса OpenRouter API
  - Отслеживание затрат на токены
  - Анализ активности пользователей

### 2.2 Дополнительные функции

#### 2.2.1 Система безопасности
- **Rate Limiting**
  - Ограничение количества запросов (10 в минуту на пользователя)
  - Защита от спама и злоупотреблений
  - Автоматическая блокировка при превышении лимитов

- **Валидация данных**
  - Проверка типов и размеров загружаемых файлов
  - Санитизация пользовательского ввода
  - Защита от инъекций и XSS атак

#### 2.2.2 Система логирования
- **Структурированные логи**
  - Логирование всех действий пользователей
  - Отслеживание ошибок и исключений
  - Ротация логов по дням
  - Различные уровни логирования (debug, info, warn, error)

## 3. Нефункциональные требования

### 3.1 Производительность
- **Время отклика**: не более 5 секунд для текстовых запросов
- **Пропускная способность**: до 100 одновременных пользователей
- **Доступность**: 99.5% uptime
- **Масштабируемость**: возможность горизонтального масштабирования

### 3.2 Надежность
- **Отказоустойчивость**: graceful degradation при сбоях внешних сервисов
- **Восстановление**: автоматический перезапуск при критических ошибках
- **Резервное копирование**: ежедневные автоматические бэкапы
- **Мониторинг**: health checks и алерты при проблемах

### 3.3 Безопасность
- **Аутентификация**: система ключей доступа
- **Авторизация**: разделение прав пользователей и администраторов
- **Шифрование**: HTTPS для всех соединений
- **Аудит**: логирование всех административных действий

### 3.4 Совместимость
- **Платформы**: Linux (Ubuntu 20.04+, CentOS 8+)
- **Браузеры**: поддержка Telegram Web
- **API**: совместимость с OpenRouter API v1
- **Базы данных**: PostgreSQL 14+, Redis 6+

## 4. Технические требования

### 4.1 Архитектура системы

#### 4.1.1 Общая архитектура
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram      │    │   Application   │    │   External      │
│   Bot API       │◄──►│   Server        │◄──►│   Services      │
│                 │    │   (Node.js)     │    │   (OpenRouter)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   Data Layer    │
                    │ PostgreSQL+Redis│
                    └─────────────────┘
```

#### 4.1.2 Компоненты системы
- **Application Server**: Node.js приложение с Express.js
- **Bot Framework**: Telegraf для работы с Telegram API
- **Database**: PostgreSQL для основных данных
- **Cache**: Redis для сессий и кэширования
- **Proxy**: Nginx для reverse proxy и SSL termination

### 4.2 Стек технологий

#### 4.2.1 Backend
- **Runtime**: Node.js 18+
- **Language**: TypeScript 5+
- **Framework**: Express.js 4+
- **Bot Framework**: Telegraf 4+
- **ORM**: Prisma 5+
- **Validation**: Zod или Joi
- **Logging**: Winston 3+

#### 4.2.2 Базы данных
- **Primary DB**: PostgreSQL 14+
- **Cache**: Redis 6+
- **File Storage**: Local filesystem или S3-compatible

#### 4.2.3 DevOps
- **Containerization**: Docker + Docker Compose
- **Reverse Proxy**: Nginx
- **Process Manager**: PM2 (опционально)
- **Monitoring**: Health checks + custom metrics

### 4.3 Структура базы данных

#### 4.3.1 Основные таблицы
```sql
-- Пользователи
CREATE TABLE users (
    id UUID PRIMARY KEY,
    telegram_id BIGINT UNIQUE NOT NULL,
    username VARCHAR(255),
    first_name VARCHAR(255),
    last_name VARCHAR(255),
    access_key_id UUID NOT NULL,
    is_admin BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Ключи доступа
CREATE TABLE access_keys (
    id UUID PRIMARY KEY,
    key VARCHAR(255) UNIQUE NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    created_by VARCHAR(255) NOT NULL,
    used_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Сообщения
CREATE TABLE messages (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    content TEXT NOT NULL,
    role VARCHAR(20) NOT NULL, -- USER, ASSISTANT, SYSTEM
    tokens INTEGER,
    cost DECIMAL(10,6),
    file_url VARCHAR(500),
    file_name VARCHAR(255),
    file_type VARCHAR(50),
    message_id INTEGER,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Статистика использования
CREATE TABLE usage (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    tokens INTEGER NOT NULL,
    cost DECIMAL(10,6) NOT NULL,
    model VARCHAR(100) NOT NULL,
    request_type VARCHAR(50) NOT NULL,
    date TIMESTAMP DEFAULT NOW()
);

-- Настройки системы
CREATE TABLE settings (
    id UUID PRIMARY KEY,
    key VARCHAR(100) UNIQUE NOT NULL,
    value TEXT NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

### 4.4 API интеграции

#### 4.4.1 OpenRouter API
- **Endpoint**: https://openrouter.ai/api/v1
- **Authentication**: Bearer token
- **Models**: GPT-4, Claude, Gemini, и другие
- **Rate Limits**: согласно тарифному плану

#### 4.4.2 Telegram Bot API
- **Endpoint**: https://api.telegram.org/bot{token}
- **Methods**: sendMessage, getFile, answerCallbackQuery
- **Webhooks**: опциональная поддержка webhook'ов

## 5. Требования к развертыванию

### 5.1 Системные требования

#### 5.1.1 Минимальные требования
- **CPU**: 1 vCPU
- **RAM**: 1GB
- **Storage**: 10GB SSD
- **Network**: 100 Mbps
- **OS**: Ubuntu 20.04+ или CentOS 8+

#### 5.1.2 Рекомендуемые требования
- **CPU**: 2 vCPU
- **RAM**: 2GB
- **Storage**: 20GB SSD
- **Network**: 1 Gbps
- **OS**: Ubuntu 22.04 LTS

### 5.2 Зависимости

#### 5.2.1 Обязательные
- Docker 20.10+
- Docker Compose 2.0+
- Git 2.30+
- Curl/Wget для скриптов

#### 5.2.2 Опциональные
- Nginx (если не используется Docker)
- PostgreSQL 14+ (если не используется Docker)
- Redis 6+ (если не используется Docker)
- Certbot для SSL сертификатов

### 5.3 Переменные окружения

#### 5.3.1 Обязательные
```env
BOT_TOKEN=telegram_bot_token
OPENROUTER_API_KEY=openrouter_api_key
DATABASE_URL=postgresql://user:pass@host:port/db
REDIS_URL=redis://host:port
ADMIN_TELEGRAM_ID=admin_user_id
```

#### 5.3.2 Опциональные
```env
NODE_ENV=production
PORT=3000
LOG_LEVEL=info
OPENROUTER_MODEL=openai/gpt-4o
MAX_FILE_SIZE=20971520
RATE_LIMIT_MAX_REQUESTS=10
RATE_LIMIT_WINDOW=60
```

## 6. Процедуры развертывания

### 6.1 Автоматическое развертывание
```bash
# Клонирование репозитория
git clone https://github.com/spochipov/ai-chat-bot.git
cd ai-chat-bot

# Настройка окружения
cp .env.example .env
# Редактирование .env файла

# Запуск развертывания
chmod +x scripts/deploy.sh
./scripts/deploy.sh production
```

### 6.2 Ручное развертывание
```bash
# Сборка и запуск контейнеров
docker-compose -f docker-compose.prod.yml up -d

# Применение миграций
docker-compose -f docker-compose.prod.yml exec app npx prisma migrate deploy

# Генерация Prisma клиента
docker-compose -f docker-compose.prod.yml exec app npx prisma generate

# Заполнение начальными данными
docker-compose -f docker-compose.prod.yml exec app npx prisma db seed
```

## 7. Тестирование

### 7.1 Виды тестирования

#### 7.1.1 Модульное тестирование
- Тестирование сервисов (DatabaseService, RedisService, OpenRouterService)
- Тестирование утилит и хелперов
- Покрытие кода не менее 80%

#### 7.1.2 Интеграционное тестирование
- Тестирование API endpoints
- Тестирование интеграции с внешними сервисами
- Тестирование middleware функций

#### 7.1.3 End-to-End тестирование
- Тестирование пользовательских сценариев
- Тестирование административных функций
- Тестирование обработки файлов

### 7.2 Инструменты тестирования
- **Unit Tests**: Jest + TypeScript
- **Integration Tests**: Supertest + Jest
- **E2E Tests**: Playwright или Puppeteer
- **Load Testing**: Artillery или K6

## 8. Мониторинг и поддержка

### 8.1 Мониторинг

#### 8.1.1 Health Checks
- HTTP endpoint `/health` для проверки состояния
- Проверка подключения к базе данных
- Проверка подключения к Redis
- Проверка доступности OpenRouter API

#### 8.1.2 Метрики
- Количество активных пользователей
- Количество обработанных сообщений
- Время отклика API
- Использование ресурсов (CPU, RAM, Disk)

#### 8.1.3 Логирование
- Структурированные JSON логи
- Ротация логов по размеру и времени
- Централизованное хранение логов
- Алерты при критических ошибках

### 8.2 Резервное копирование

#### 8.2.1 Автоматические бэкапы
- Ежедневные дампы PostgreSQL
- Снапшоты Redis данных
- Резервные копии загруженных файлов
- Хранение бэкапов в течение 30 дней

#### 8.2.2 Восстановление
- Процедуры восстановления из бэкапов
- Point-in-time recovery для базы данных
- Тестирование процедур восстановления

## 9. Безопасность

### 9.1 Меры безопасности

#### 9.1.1 Аутентификация и авторизация
- Система ключей доступа с уникальными токенами
- Разделение прав пользователей и администраторов
- Сессионное управление через Redis
- Автоматическая деактивация неактивных сессий

#### 9.1.2 Защита данных
- Шифрование соединений (HTTPS/TLS)
- Хеширование чувствительных данных
- Валидация и санитизация пользовательского ввода
- Защита от SQL инъекций через ORM

#### 9.1.3 Сетевая безопасность
- Firewall правила для ограничения доступа
- Rate limiting на уровне приложения и Nginx
- DDoS защита через reverse proxy
- Регулярные обновления безопасности

### 9.2 Аудит безопасности
- Логирование всех административных действий
- Мониторинг подозрительной активности
- Регулярные проверки безопасности
- Обновление зависимостей и исправление уязвимостей

## 10. Документация

### 10.1 Пользовательская документация
- README.md с общим описанием проекта
- QUICK_START.md для быстрого начала работы
- Руководство пользователя для работы с ботом
- FAQ с часто задаваемыми вопросами

### 10.2 Техническая документация
- ARCHITECTURE.md с описанием архитектуры
- API документация для разработчиков
- Руководство по развертыванию
- Руководство по администрированию

### 10.3 Документация для разработчиков
- Руководство по настройке среды разработки
- Стандарты кодирования и code review
- Процедуры тестирования и деплоя
- Архитектурные решения и их обоснование

## 11. Планы развития

### 11.1 Версия 1.0 (MVP)
- ✅ Базовая функциональность чат-бота
- ✅ Интеграция с OpenRouter API
- ✅ Система контроля доступа
- ✅ Административная панель
- ✅ Docker развертывание

### 11.2 Версия 1.1 (Улучшения)
- [ ] Веб-интерфейс для администрирования
- [ ] Поддержка голосовых сообщений
- [ ] Расширенная аналитика и отчеты
- [ ] Интеграция с Prometheus/Grafana

### 11.3 Версия 1.2 (Расширения)
- [ ] Поддержка множественных AI провайдеров
- [ ] Система плагинов
- [ ] Мультиязычность интерфейса
- [ ] API для внешних интеграций

### 11.4 Версия 2.0 (Масштабирование)
- [ ] Микросервисная архитектура
- [ ] Kubernetes развертывание
- [ ] Горизонтальное автомасштабирование
- [ ] Распределенное кэширование

## 12. Заключение

Данное техническое задание определяет требования к разработке AI Chat Bot для Telegram - современного, масштабируемого и безопасного решения для предоставления доступа к AI моделям через популярный мессенджер.

Проект реализован с использованием современных технологий и лучших практик разработки, что обеспечивает:
- Высокую производительность и надежность
- Простоту развертывания и поддержки
- Возможность масштабирования и развития
- Соответствие требованиям безопасности

Система готова к использованию в production среде и может быть адаптирована под различные бизнес-требования.
