# Интеграция с OpenAI API

Этот документ описывает, как использовать прямое подключение к OpenAI API в дополнение к существующему OpenRouter.

## Обзор

Бот теперь поддерживает два AI провайдера:
- **OpenRouter** - агрегатор различных AI моделей (по умолчанию)
- **OpenAI** - прямое подключение к официальному API OpenAI

## Конфигурация

### Переменные окружения

Добавьте следующие переменные в ваш `.env` файл:

```bash
# AI Provider Configuration
AI_PROVIDER=openrouter  # или openai

# OpenAI API Configuration
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4
OPENAI_BASE_URL=https://api.openai.com/v1
```

### Получение API ключа OpenAI

1. Зарегистрируйтесь на [platform.openai.com](https://platform.openai.com)
2. Перейдите в раздел API Keys
3. Создайте новый API ключ
4. Добавьте ключ в переменную `OPENAI_API_KEY`

## Использование

### Автоматическое переключение

Система автоматически выберет доступного провайдера:
1. Сначала попробует использовать провайдера по умолчанию (указанный в `AI_PROVIDER`)
2. Если основной провайдер недоступен, переключится на альтернативного
3. Если оба недоступны, вернет ошибку

### Команды администратора

Администратор может управлять провайдерами через команду `/provider`:

#### Показать статус провайдеров
```
/provider
```
Отображает:
- Текущий активный провайдер
- Доступность каждого провайдера
- Модели по умолчанию

#### Переключить провайдера
```
/provider set openai
/provider set openrouter
```

#### Проверить здоровье провайдеров
```
/provider health
```

#### Показать доступные модели
```
/provider models openai
/provider models openrouter
```

## Поддерживаемые модели OpenAI

### Текстовые модели
- `gpt-4` - Самая мощная модель GPT-4
- `gpt-4-turbo` - Быстрая версия GPT-4
- `gpt-4o` - Оптимизированная версия GPT-4
- `gpt-4o-mini` - Компактная версия GPT-4o
- `gpt-3.5-turbo` - Быстрая и экономичная модель

### Модели с поддержкой изображений
- `gpt-4o` - Поддерживает анализ изображений
- `gpt-4-turbo` - Поддерживает анализ изображений

## Ценообразование

Система автоматически рассчитывает стоимость запросов на основе официальных цен OpenAI:

| Модель | Цена за 1K токенов (input) | Цена за 1K токенов (output) |
|--------|----------------------------|------------------------------|
| GPT-4 | $0.03 | $0.06 |
| GPT-4o | $0.005 | $0.015 |
| GPT-4o-mini | $0.00015 | $0.0006 |
| GPT-4-turbo | $0.01 | $0.03 |
| GPT-3.5-turbo | $0.001 | $0.002 |

## Особенности реализации

### Архитектура

```
AIService (универсальный интерфейс)
├── OpenRouterService (существующий)
└── OpenAIService (новый)
```

### Автоматическое переключение

Если основной провайдер недоступен, система:
1. Логирует ошибку
2. Проверяет доступность альтернативного провайдера
3. Автоматически переключается на него
4. Уведомляет в логах о переключении

### Обработка ошибок

Система обрабатывает специфичные ошибки каждого провайдера:
- **401** - Неверный API ключ
- **429** - Превышен лимит запросов
- **400** - Некорректный запрос
- **5xx** - Проблемы на стороне сервера

## Мониторинг

### Логирование

Все операции с AI провайдерами логируются:
```javascript
// Успешный запрос
logger.info('Message processed successfully', {
  provider: 'openai',
  model: 'gpt-4',
  tokens: 150,
  cost: 0.009
});

// Переключение провайдера
logger.info('Trying alternative provider: openai');
```

### Метрики

В базе данных сохраняется информация о:
- Использованных токенах
- Стоимости запросов
- Используемой модели
- Провайдере

## Миграция

### С OpenRouter на OpenAI

1. Получите API ключ OpenAI
2. Добавьте переменные окружения
3. Используйте команду `/provider set openai`

### Обратная совместимость

Существующий функционал с OpenRouter остается без изменений. Все старые конфигурации продолжают работать.

## Устранение неполадок

### OpenAI API недоступен

```bash
# Проверьте API ключ
curl -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models

# Проверьте баланс
curl -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/dashboard/billing/credit_grants
```

### Ошибки аутентификации

1. Убедитесь, что API ключ корректный
2. Проверьте, что у вас есть доступ к нужным моделям
3. Убедитесь, что на аккаунте есть средства

### Проблемы с переключением

Используйте команду `/provider health` для диагностики доступности провайдеров.

## Безопасность

### Защита API ключей

- Никогда не коммитьте API ключи в репозиторий
- Используйте переменные окружения
- Регулярно ротируйте ключи
- Ограничьте права доступа ключей

### Мониторинг использования

- Отслеживайте расходы через OpenAI Dashboard
- Настройте лимиты использования
- Мониторьте необычную активность

## Примеры использования

### Программное переключение провайдера

```typescript
// Установить OpenAI как провайдера по умолчанию
AIService.setDefaultProvider('openai');

// Отправить сообщение с принудительным использованием OpenAI
const response = await AIService.sendMessage(messages, {
  provider: 'openai',
  model: 'gpt-4o'
});
```

### Проверка доступности

```typescript
// Проверить доступность OpenAI
const isAvailable = await AIService.isProviderAvailable('openai');

// Получить статус всех провайдеров
const health = await AIService.healthCheckAll();
console.log(health); // { openrouter: true, openai: false }
